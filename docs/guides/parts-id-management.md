# パーツID管理ガイド

このドキュメントでは、AC6アセンブルツールにおけるパーツIDの管理方法を説明します。

## 概要

パーツIDは、各パーツを一意に識別するためのグローバルユニークIDです。URL共有やデータ保存時にパーツを特定するために使用されます。

## ID命名規則

パーツIDは以下の形式で構成されます：

```text
{カテゴリコード}{連番}
```

### カテゴリコード

各パーツカテゴリに対応する2〜3文字のコードです：

| カテゴリ | コード | 例 |
|---------|--------|-----|
| Head（頭部） | `HD` | HD001, HD002, ... |
| Core（コア） | `CR` | CR001, CR002, ... |
| Arms（腕部） | `AR` | AR001, AR002, ... |
| Legs（脚部） | `LG` | LG001, LG002, ... |
| Booster（ブースター） | `BS` | BS001, BS002, ... |
| FCS | `FCS` | FCS001, FCS002, ... |
| Generator（ジェネレータ） | `GN` | GN001, GN002, ... |
| Expansion（拡張） | `EXP` | EXP001, EXP002, ... |
| Arm Unit（腕武器） | `AU` | AU001, AU002, ... |
| Back Unit（肩武器） | `BU` | BU001, BU002, ... |
| Not Equipped（未装備） | `NE` | NE001, NE002, ... |

### 連番

カテゴリ内で一意な3〜4桁の数字です。001から開始し、順次インクリメントします。

## ID生成方法

### スクリプトを使用したID生成

新しいパーツを追加する際は、ID生成スクリプトを使用します：

```bash
cd packages/parts
pnpm run gen-id <category>
```

例：

```bash
# 頭部パーツの次のIDを生成
pnpm run gen-id head
# => HD024

# 腕武器の次のIDを生成
pnpm run gen-id arm-unit
# => AU061
```

スクリプトは既存のパーツIDを読み込み、次の連番を自動的に計算します。

### 手動でのID付与

スクリプトを使用せずに手動でIDを付与する場合は、以下の点に注意してください：

1. **カテゴリコードを正しく使用**：上記の表を参照してください
2. **連番の重複を避ける**：既存のパーツIDを確認し、最大値+1を使用してください
3. **3桁の連番を維持**：001, 002, ..., 099, 100, ...のように0埋めしてください

## ID重複チェック

パーツIDの重複を防ぐため、以下の2つの検証機構があります：

### 1. 起動時検証

アプリケーション起動時に全パーツのID重複をチェックします。

- 重複が検出された場合、エラーログを出力して起動を中断します
- 検証成功時はinfoレベルでログ出力します

### 2. ビルド時検証

ビルドプロセスでID重複を検証します。

```bash
cd packages/parts
pnpm run validate-ids
```

- 重複検出時はビルドを失敗させます
- エラーメッセージに重複IDと競合パーツ名を表示します

## パッチバージョン適用時のID管理

### 新規パーツ追加

1. **ID生成スクリプトを実行**して次のIDを取得
2. **新しいパーツ定義を作成**してIDを付与
3. **ビルド時検証を実行**して重複がないことを確認

例：

```typescript
// packages/parts/src/heads.ts
export const newHead: Head = {
  id: 'HD024', // スクリプトで生成したID
  name: 'New Head',
  classification: 'head',
  // ... その他のプロパティ
}

export const heads: readonly Head[] = [
  // ... 既存のパーツ
  newHead,
]
```

### パーツ削除

パーツを削除する場合、**IDは保持**します。これにより、既存の保存データやURLで削除されたパーツを参照している場合でも、フォールバック処理が正しく機能します。

削除するパーツをコメントアウトするのではなく、配列から削除してください。IDは欠番として残ります。

### パーツステータス変更

パーツのステータス（名前、性能値など）を変更する場合、**IDは変更しません**。同一パーツのステータス変更であれば、IDは不変です。

## ID管理のベストプラクティス

### ✅ 推奨

- ID生成スクリプトを使用してIDを生成する
- ビルド前に`pnpm run validate-ids`を実行する
- IDは一度付与したら変更しない
- パーツ追加時は配列の最後に追加する

### ❌ 避けるべき

- 手動でIDを作成する（スクリプトを使用してください）
- 既存のパーツのIDを変更する
- IDを重複させる
- IDの連番を飛ばす（欠番は許容されます）

## トラブルシューティング

### ID重複エラーが発生した場合

1. **エラーメッセージを確認**：重複しているIDと競合パーツ名が表示されます
2. **該当ファイルを確認**：競合しているパーツ定義を見つけます
3. **一方のIDを変更**：ID生成スクリプトで新しいIDを生成して付与します
4. **再度検証を実行**：`pnpm run validate-ids`で重複が解消されたことを確認します

### ID生成スクリプトが動作しない場合

1. **カテゴリ名を確認**：正しいカテゴリ名（head, core, arms, legs, arm-unit, back-unit等）を使用しているか確認します
2. **パーツファイルの存在を確認**：該当カテゴリのパーツファイル（heads.ts, cores.ts等）が存在するか確認します
3. **パーツ配列のエクスポートを確認**：パーツ配列が正しくエクスポートされているか確認します

## 関連ファイル

- **ID生成スクリプト**：`packages/parts/scripts/generate-part-id.ts`
- **ID検証ロジック**：`packages/parts/src/validation/id-validator.ts`
- **起動時検証**：`packages/parts/src/validation/validate-on-startup.ts`
- **パーツ定義**：`packages/parts/src/*.ts`（heads.ts, cores.ts, ...）

## まとめ

パーツIDは一度付与したら変更しない不変の識別子です。ID生成スクリプトと検証機構を活用して、重複のない正しいID管理を行ってください。
