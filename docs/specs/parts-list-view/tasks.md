# 実装タスク

## タスク一覧

- [x] 1. プロジェクト基盤とデータ永続化の構築
- [x] 1.1 お気に入り管理のためのIndexedDBスキーマを設計・実装
  - スロット単位でお気に入りパーツを管理できるデータベーススキーマを定義
  - パーツIDとスロットの組み合わせで一意性を保証する仕組みを実装
  - お気に入り追加・削除・取得・存在確認の基本操作を提供
  - データベースアクセスエラーを適切に処理し、Result型で返却
  - _Requirements: 6.1_

- [x] 1.2 状態のシリアライゼーション機能を実装
  - スロット選択、フィルタ条件、並び替え設定をURLパラメータに変換
  - URLパラメータから状態を復元し、不正な値はデフォルトにフォールバック
  - 表示モード（grid/list）をLocalStorageに保存・復元
  - URL共有用の状態とプライベート設定を明確に分離
  - _Requirements: 7.1, 7.2, 7.4, 8.1, 8.2, 8.3_

- [x] 2. パーツ一覧ページのルーティングと基本構造を構築
- [x] 2.1 パーツ一覧ページのルートを作成
  - `/parts-list` ルートを新規作成し、SvelteKitのルーティングに統合
  - URLパラメータからスロット・フィルタ・並び替えの初期状態を復元
  - パーツデータのロード処理とエラーハンドリングを実装
  - ページ全体のレイアウトとナビゲーション構造を構築
  - _Requirements: 1.1, 7.2_

- [x] 2.2 パーツ一覧ページのメインコンポーネントを実装
  - スロット選択、フィルタ、並び替え、表示モードの状態を統合管理
  - 状態変更時にURLパラメータとLocalStorageを自動更新
  - 子コンポーネント（スロット選択、フィルタ、並び替え、一覧表示）を統合
  - フィルタ済みパーツリストをリアクティブに計算（$derived使用）
  - _Requirements: 1.1, 1.2_

- [x] 3. スロット選択機能とスロット文脈の管理を実装
- [x] 3.1 スロット選択UIを実装
  - 12種類のスロットを選択できるUIコンポーネントを作成
  - 選択中のスロットを視覚的に明示
  - スロット切替イベントを親コンポーネントに通知
  - モバイル環境でタップしやすいUI設計
  - _Requirements: 1.1, 1.2_

- [ ] 3.2 スロットごとの独立フィルタ管理を実装
  - 各スロット（12種類）ごとに独立したフィルタ状態を保持
  - スロット切替時に該当スロットのフィルタ状態を復元
  - フィルタ変更時に現在のスロットのフィルタ状態を更新
  - スロットごとのフィルタ状態をLocalStorageに保存・復元
  - URL共有時は現在選択中のスロットのフィルタのみをシリアライズ
  - _Requirements: 1.3, 2.5.1, 2.5.2, 2.5.3, 2.5.4, 2.5.5_

- [x] 4. フィルタリング機能を実装
- [x] 4.1 パーツ一覧ページに最適化されたフィルタリングロジックを実装
  - **注**: 既存のPartsFilterSet（アセンブリページ用）は使用せず、パーツ一覧ページ専用の新しいフィルタリングを実装
  - シンプルなAND条件での複数フィルタ適用（applyFilters関数）
  - スロットごとに有効な属性のみを取得する仕組みを構築
  - フィルタ条件を満たさないパーツを一覧から除外
  - 属性未定義（undefined/null）のパーツを適切に処理
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 4.2 フィルタ設定UIを実装
  - 選択中スロットで意味を持つ属性のみをフィルタ項目として表示
  - 数値範囲フィルタ（min/max）と等価フィルタ（値選択）を提供
  - フィルタ条件の追加・削除・クリア機能を実装
  - スロット切替で無効化された条件をUIで明示（エラー扱いはしない）
  - 折りたたみ機能を追加してスクロール量を調整可能に
  - **修正完了 (2025-10-25)**: operandバインディング問題の修正
    - Svelteの`<select>`要素でoperandオブジェクトを直接バインドできない問題に対応
    - operand IDをバインドし、`handleAddFilter`時にIDからoperandオブジェクトを取得する方式に変更
    - FilterPanel.svelte: `propertyOperand` → `propertyOperandId`, `nameOperand` → `nameOperandId`
  - **修正完了 (2025-10-25)**: i18nコンテキスト問題の修正
    - SlotSelector.svelte: `import i18n from '...'` を `getContext<I18NextStore>('i18n')` に変更
  - _Requirements: 2.1, 2.2, 9.1_

- [x] 4.3 名前・メーカー・カテゴリフィルタの詳細仕様を実装
  - **名前フィルタ**：テキスト検索に3つの検索モード（完全一致・含む・含まない）を実装
  - 検索モード選択UIを追加し、デフォルトは「含む」に設定
  - 大文字小文字を区別しない検索を実装
  - **メーカーフィルタ**：選択式（複数可）に変更し、チェックボックスリストまたはマルチセレクトで実装
  - メーカーフィルタのOR条件（いずれかのメーカーに該当すれば表示）を実装
  - 現在のスロットに存在するメーカーのみを選択肢として動的に生成
  - **カテゴリフィルタ**：選択式（複数可）に変更し、チェックボックスリストまたはマルチセレクトで実装
  - カテゴリフィルタのOR条件（いずれかのカテゴリに該当すれば表示）を実装
  - 現在のスロットに存在するカテゴリのみを選択肢として動的に生成
  - **分類フィルタ**：スロット選択と重複するため、フィルタUIから除外
  - _Requirements: 2.1, 2.2_

- [ ] 5. 並び替え機能を実装
- [ ] 5.1 並び替えロジックとUIを実装
  - 選択中スロットで有効な属性を並び替え項目として提示
  - 昇順/降順での並び替えを実装
  - 属性未定義のパーツを序列外（末尾）に配置
  - 並び替え状態をURL/ローカルストレージに保持
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 6. パーツ一覧表示とお気に入り機能を実装
- [ ] 6.1 パーツ一覧表示コンポーネントを実装
  - グリッド表示とリスト表示の2つの表示モードを提供
  - フィルタ・並び替え済みのパーツを表示
  - パーツの主要情報（名前、画像、重量、価格など）を視覚的に表示
  - モバイル環境での視認性とタップ操作性を確保
  - _Requirements: Performance.1, Usability.1_

- [ ] 6.2 お気に入り管理機能を統合
  - お気に入り追加・削除ボタンをパーツカードに配置
  - お気に入り状態を視覚的に明示（アイコン変化）
  - スロット単位でお気に入りを管理
  - お気に入りフィルタを適用してお気に入り登録パーツのみを表示
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 6.3 0件時の表示とエラーハンドリングを実装
  - フィルタ結果が0件の場合、EmptyStateコンポーネントを表示
  - 0件時もスロット選択とフィルタ変更を可能にする
  - 0件である旨を明確に表示し、条件緩和を促す
  - エラーではなく情報として扱い、探索を継続可能にする
  - _Requirements: 2.4, 4.1, 4.2, 4.3, 4.4_

- [ ] 7. アセンブリページへの母集団受け渡し機能を実装
- [ ] 7.1 フィルタ済みパーツIDリストの生成とナビゲーションを実装
  - フィルタ済みパーツのIDリストを抽出
  - スロットごとのパーツIDリストをURLパラメータにシリアライズ
  - 「アセンに渡す」ボタンでアセンブリページに遷移
  - フィルタ条件をURL状態として保持したまま遷移
  - _Requirements: 3.1, 3.3_

- [ ] 7.2 アセンブリページでの母集団制限ロジックを実装
  - URLパラメータからスロットごとのパーツIDリストを受け取る
  - 受け取ったIDリストで選択可能なパーツを制限
  - 制限された母集団のみをパーツ選択UIに表示
  - パーツIDリストが不正な場合はデフォルト（全パーツ）にフォールバック
  - _Requirements: 3.2, 3.4_

- [ ] 8. アセンブリページからのフィルタ機能廃止
- [ ] 8.1 アセンブリページのフィルタUIを削除
  - FilterByPartsOffCanvasなどフィルタ関連コンポーネントを削除
  - フィルタボタン・パネルをアセンブリページから削除
  - フィルタ関連の状態管理コードを削除
  - UIレイアウトをフィルタ削除に合わせて調整
  - _Requirements: Migration Strategy Phase 3_

- [ ] 8.2 組み立て機能の維持確認
  - ロック機能が正しく動作することを確認
  - ランダム生成機能が正しく動作することを確認
  - 計算結果表示機能が正しく動作することを確認
  - パーツ一覧ページから渡された母集団で組み立てができることを確認
  - _Requirements: Migration Strategy Phase 3_

- [ ] 9. 国際化とアクセシビリティを実装
- [ ] 9.1 多言語対応を実装
  - パーツ一覧ページの全UIテキストを国際化リソースに登録
  - 日本語・英語の翻訳を提供
  - 既存のi18next設定を活用してロケール切り替えを実装
  - スロット名、属性名、メッセージを多言語化
  - _Requirements: User Experience.2_

- [ ] 9.2 アクセシビリティ対応を実装
  - キーボード操作でスロット選択・フィルタ設定が可能にする
  - スクリーンリーダー対応のARIAラベルを追加
  - フォーカス管理を適切に実装
  - カラーコントラストを確保し、視認性を向上
  - _Requirements: Usability.1_

- [ ] 10. テストを実装
- [x] 10.1 ユニットテストを実装
  - [x] お気に入り追加・削除・取得のテスト（favorite-store.spec.ts）
  - [x] 状態シリアライゼーション・デシリアライゼーションのテスト（state-serializer.spec.ts: 29/29テスト成功）
  - [x] スロット切替時の条件引き継ぎロジックのテスト（PartsListView.spec.ts）
  - [x] フィルタ適用ロジックのテスト（filters-core.spec.ts）
  - [ ] 並び替えロジックのテスト（未実装）
  - [x] **残課題**: FilterPanel.spec.tsとSlotSelector.spec.tsのi18nコンテキスト対応と新Filter型への移行
    - **修正完了 (2025-10-26)**: 2コンポーネントのユニットテストを実装仕様に合わせて更新（i18nコンテキスト注入、新Filter型のビルダー活用）
  - _Requirements: Testing Strategy Unit Tests_

- [ ] 10.2 統合テストを実装
  - パーツ一覧ページの初期表示テスト
  - フィルタ適用フローのテスト
  - スロット切替フローのテスト
  - お気に入り管理フローのテスト
  - アセンブリページへの遷移フローのテスト
  - _Requirements: Testing Strategy Integration Tests_

- [ ] 10.3 E2Eテストを実装
  - パーツ探索から組み立てまでの完全フローのテスト
  - URL共有フローのテスト
  - ローカル復元フローのテスト
  - モバイル操作フローのテスト
  - 0件からの回復フローのテスト
  - _Requirements: Testing Strategy E2E Tests_

- [ ] 11. パフォーマンス最適化と本番対応
- [ ] 11.1 パフォーマンス最適化を実装
  - フィルタ結果キャッシュ（$derived によるメモ化）を実装
  - 大量パーツ（100件以上）の場合の仮想スクロールを実装
  - パーツ画像の遅延ロード（loading="lazy"）を実装
  - お気に入りデータのメモリキャッシュを実装
  - _Requirements: Performance.1, Performance.2, Performance & Scalability_

- [ ] 11.2 パフォーマンステストを実施
  - 初回表示パフォーマンス（目標: 3秒以内）を測定
  - フィルタ適用パフォーマンス（目標: 1秒以内）を測定
  - スロット切替パフォーマンス（目標: 1秒以内）を測定
  - お気に入り操作パフォーマンス（目標: 500ms以内）を測定
  - _Requirements: Performance.1, Performance.2, Performance & Scalability_

- [ ] 11.3 エラー監視と構造化ログを実装
  - すべてのエラーを構造化ログとして出力（JSON形式）
  - ログレベル（info/warn/error/fatal）を適切に設定
  - IndexedDB可用性チェックとヘルスモニタリングを実装
  - ユーザー体験メトリクス（0件発生率、お気に入り利用率）を記録
  - _Requirements: Error Handling Monitoring_

- [ ] 12. ドキュメント更新とクリーンアップ
- [ ] 12.1 未使用コードの削除
  - 削除されたフィルタコンポーネントの依存関係を確認
  - 未使用のインポート・型定義を削除
  - デッドコードを検出して削除
  - _Requirements: Migration Strategy Phase 4_

- [ ] 12.2 ユーザー向けドキュメントの更新
  - パーツ一覧ページの使い方ガイドを作成
  - アセンブリページとの連携方法を説明
  - URL共有機能の使用例を記載
  - トラブルシューティング情報を追加
  - _Requirements: Migration Strategy Phase 4_

## 要件カバレッジマトリクス

| 要件ID | 要件概要 | 対応タスク |
|--------|---------|-----------|
| 1.1 | 初期表示で1スロット選択 | 2.1, 2.2, 3.1 |
| 1.2 | スロット選択でパーツ一覧表示 | 2.2, 3.1 |
| 1.3 | スロット切替で文脈切替 | 3.2 |
| 2.1 | スロット対応属性のみ提示 | 4.1, 4.2 |
| 2.2 | フィルタ条件適用 | 4.1, 4.2 |
| 2.3 | 属性未定義パーツの除外 | 4.1 |
| 2.4 | 0件時の明示 | 6.3 |
| 2.5 | スロット切替時の条件引き継ぎ | 3.2 |
| 3.1 | アセンページへの受け渡し | 7.1 |
| 3.2 | アセンページでの母集団制限 | 7.2 |
| 3.3 | フィルタ条件の保持 | 7.1 |
| 3.4 | スロット単位の受け渡し | 7.2 |
| 4.1-4.4 | 0件時の操作継続性 | 6.3 |
| 5.1-5.4 | 並び替え機能 | 5.1 |
| 6.1-6.4 | お気に入り管理 | 1.1, 6.2 |
| 7.1-7.4 | URL共有 | 1.2, 2.1 |
| 8.1-8.3 | ローカル復元 | 1.2, 2.1 |
| 9.1-9.4 | スロット切替時の条件明示 | 3.2, 4.2 |
| Performance.1 | 初回表示3秒以内 | 6.1, 11.1, 11.2 |
| Performance.2 | フィルタ1秒以内 | 11.1, 11.2 |
| Usability.1 | モバイル対応 | 6.1, 9.2 |
| Usability.2 | 状態保持の即時反映 | 2.2 |
| User Experience.1 | 状態明示 | 6.3 |
| User Experience.2 | 原作拡張の操作性 | 9.1 |

## 実装の優先順位

### Phase 1: パーツ一覧ページ実装 (Must Requirements)

- タスク 1, 2, 3, 4, 5, 6

### Phase 2: アセンブリページ統合

- タスク 7

### Phase 3: フィルタ機能廃止

- タスク 8

### Phase 4: 品質向上と本番対応

- タスク 9, 10, 11, 12
