# 実装計画: スロット固有属性によるフィルター・ソート機能

## 概要

本ドキュメントでは、パーツリストビューにおけるスロット固有属性によるフィルター・ソート機能の実装タスクを定義します。各タスクは段階的に機能を構築し、既存システムとの統合を確実に行います。

---

## フェーズ 1: 基盤整備（Week 1）

### 1. 属性メタデータ取得基盤の構築

- [x] 1.1 属性定義抽出ユーティリティの実装
  - attributes.ts からスロットごとの属性定義を取得する機能を実装
  - valueType（numeric, array, literal）に基づいて属性を分類
  - literal型属性を自動的に除外し、フィルター・ソート対象のみを抽出
  - 属性定義の順序を attributes.ts の定義順通りに維持
  - **NOTE**: 以降のフィルター／ソート候補生成は必ずこのユーティリティ経由で `attributes.ts` の情報を参照すること
  - _Requirements: 1.1, 1.3_

- [x] 1.2 属性タイプ別取得機能の実装
  - 数値型属性のリストを取得する機能を実装
  - 配列型属性のリストを取得する機能を実装
  - 属性のオプショナル判定機能を実装
  - _Requirements: 1.1_

- [x] 1.3 配列型属性の選択肢抽出機能の実装
  - candidates フィールドから選択肢を動的に取得する機能を実装
  - スロットごとに利用可能な選択肢を提供
  - 空の candidates に対する適切なハンドリング
  - _Requirements: 2.3_

- [x] 1.4 属性取得ユーティリティの単体テスト
  - 各スロットタイプで正しい属性リストが返されることを検証
  - 数値型・配列型の分類が正しく行われることを検証
  - literal型属性が除外されることを検証
  - optional フラグの判定が正しいことを検証
  - _Requirements: 非機能要件（テスタビリティ）_

---

## フェーズ 2: フィルタリング機能の拡張（Week 1-2）

### 2. 動的属性フィルタリング機能の実装

- [x] 2.1 PropertyFilterKey型の拡張
  - PropertyFilterKey を固定ユニオン型から string 型に変更
  - 実行時の属性名検証ロジックを追加
  - 既存のフィルター構築関数との互換性を維持
  - **NOTE**: フィルター候補・演算対象の属性リストは 1.x で構築した `attributes.ts` ベースのユーティリティから取得すること
  - _Requirements: 1.1, 非機能要件（互換性）_

- [x] 2.2 配列型属性フィルター構築機能の汎用化
  - 汎用的な配列型フィルター構築関数を実装
  - candidates フィールドを使用した選択肢の動的生成
  - 既存の buildCategoryFilter / buildManufactureFilter との統合
  - _Requirements: 2.3_

- [x] 2.3 属性翻訳機能の拡張
  - 動的属性名の翻訳機能を実装
  - i18n リソースが存在しない場合のフォールバック処理（キャメルケース変換）を実装
  - フィルター条件文字列化時の翻訳適用
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

- [x] 2.4 フィルター機能の単体テスト
  - 数値型属性フィルターの動作を検証
  - 配列型属性フィルターの動作を検証
  - optional属性フィルター時に属性なしパーツが除外されることを検証
  - 複数フィルター条件のAND適用を検証
  - _Requirements: 2.2, 2.3, 2.4, 4.1, 4.2, 4.5_

---

## フェーズ 3: ソート機能の拡張（Week 2）

### 3. 動的属性ソート機能の実装

- [x] 3.1 SortKey型の拡張
  - SortKey を PropertyFilterKey に合わせて string 型に変更
  - 配列型属性のソート対応を追加
  - 既存のソート関数との互換性を維持
  - **NOTE**: ソート候補となる属性も `attributes.ts` の定義を参照して決定し、スロットごとの属性集合を 1.x のユーティリティから取得すること
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 3.2 配列型属性ソート機能の実装
  - 配列の最初の要素を取り出して文字列比較するロジックを実装
  - 配列が空または undefined の場合の処理を実装
  - 昇順・降順のソートを正しく適用
  - _Requirements: 3.3_

- [x] 3.3 optional属性ソート機能の実装
  - 属性を持つパーツと持たないパーツを分類
  - 属性を持つパーツを指定順序でソート
  - 属性を持たないパーツを末尾にまとめて配置
  - 属性を持たないパーツの元の順序を維持
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3.4 ソート機能の単体テスト
  - 数値型属性の昇順・降順ソートを検証
  - 配列型属性の文字列ソートを検証
  - optional属性ソート時の属性なしパーツの配置を検証
  - ソート時の安定性（同値パーツの順序維持）を検証
  - _Requirements: 3.2, 3.3, 5.1, 5.2, 5.3, 5.4, 5.5_

---

## フェーズ 4: UIコンポーネントの統合（Week 2-3）

### 4. PartsListViewコンポーネントの統合

- [x] 4.1 利用可能属性の動的取得機能の追加
  - スロット変更時に属性取得ユーティリティを呼び出す処理を追加
  - 取得した属性定義を $derived で管理
  - availableAttributes を FilterPanel と SortControl に渡す
  - _Requirements: 1.1, 1.2_

- [x] 4.2 スロット変更時のフィルター・ソートクリア機能の実装
  - スロット変更時に既存のフィルターをクリアする処理を追加
  - 新しいスロットで利用不可能なソート属性を自動クリア
  - フィルター・ソート状態のリセット後の適切な初期化
  - _Requirements: 2.6, 3.5, 3.6_

- [x] 4.3 属性リスト更新の応答性能検証
  - スロット変更から属性リスト表示までの時間を測定
  - 100ms 以内の応答を確認
  - パフォーマンスボトルネックの特定と最適化
  - _Requirements: 7.1_

---

### 5. FilterPanelコンポーネントの拡張

- [x] 5.1 動的属性選択UIの実装
  - availableAttributes を受け取り、動的に属性選択肢を生成
  - 属性の表示順序を attributes.ts の定義順通りに維持
  - スロット変更時の属性リスト即座切り替え
  - _Requirements: 1.2, 1.3, 2.1, 2.6_

- [x] 5.2 valueTypeに基づくフィルターUI分岐の実装
  - 数値型属性選択時に数値比較UIを表示（演算子 + 数値入力）
  - 配列型属性選択時に選択UIを表示（チェックボックスまたはドロップダウン）
  - candidates から選択肢を動的生成
  - _Requirements: 2.2, 2.3_

- [x] 5.3 フィルター適用とリアルタイム絞り込み機能の実装
  - フィルター変更時のリアルタイム結果更新
  - 該当件数の表示
  - フィルター条件に一致するパーツが0件の場合のメッセージ表示
  - _Requirements: 2.4, 2.5, 4.4_

- [x] 5.4 属性名翻訳の適用
  - 属性選択肢に翻訳された属性名を表示
  - フィルター条件文字列化時に翻訳を適用
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

---

### 6. SortControlコンポーネントの拡張

- [x] 6.1 動的属性選択UIの実装
  - availableAttributes を受け取り、動的に属性選択肢を生成
  - 数値型・配列型両方の属性を選択肢として表示
  - スロット変更時の属性リスト即座切り替え
  - _Requirements: 3.1, 3.5_

- [x] 6.2 ソート適用とパーツ並び替え機能の実装
  - ソート属性と順序の選択UI
  - ソート適用時のパーツリスト並び替え
  - スロット変更時の無効なソート属性の自動クリア
  - _Requirements: 3.2, 3.3, 3.4, 3.6_

- [x] 6.3 属性名翻訳の適用
  - ソート属性選択肢に翻訳された属性名を表示
  - 翻訳が存在しない場合のフォールバック表示
  - _Requirements: 6.1, 6.2, 6.4_

---

## フェーズ 5: 統合テストとエラーハンドリング（Week 3-4）

### 7. 統合テストの実装

- [x] 7.1 PartsListView + FilterPanel 統合テスト
  - スロット変更時の属性リスト更新をテスト
  - 数値型属性フィルターの適用をテスト
  - 配列型属性フィルターの適用をテスト
  - optional属性フィルター時の動作をテスト
  - 複数フィルター条件のAND適用をテスト
  - _Requirements: 1.2, 2.1, 2.2, 2.3, 2.4, 2.6, 4.1, 4.2, 4.5_

- [x] 7.2 PartsListView + SortControl 統合テスト
  - スロット変更時の属性リスト更新をテスト
  - 数値型属性ソートの適用をテスト
  - 配列型属性ソートの適用をテスト
  - optional属性ソート時の動作をテスト
  - スロット変更時の無効なソート属性クリアをテスト
  - _Requirements: 3.1, 3.2, 3.3, 3.5, 3.6, 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 7.3 フィルター・ソート組み合わせテスト
  - フィルターとソートを同時適用した場合の動作をテスト
  - スロット変更時のフィルター・ソート状態のクリアをテスト
  - URL パラメータへの状態シリアライゼーションをテスト
  - _Requirements: 非機能要件（互換性）_

---

### 8. エラーハンドリングとフォールバック

---

## フェーズ 6: パフォーマンス最適化と最終検証（Week 4）

### 9. パフォーマンス最適化

- [ ] 9.1 属性取得のメモ化実装
  - getAttributesForSlot の結果をキャッシュ
  - 同一スロットへの繰り返しアクセスを高速化
  - メモリ使用量の監視
  - _Requirements: 7.1_

- [ ] 9.2 フィルター・ソート処理の最適化
  - 100件のパーツに対するフィルター適用を50ms以内に最適化
  - 100件のパーツに対するソート適用を50ms以内に最適化
  - パフォーマンス測定とボトルネック特定
  - _Requirements: 7.3, 7.4_

- [ ] 9.3 UI応答性の検証
  - フィルター・ソート処理中のUI応答性を確認
  - スクロール操作の滑らかさを検証
  - 大量パーツ（100件以上）での動作を確認
  - _Requirements: 7.2, 7.4_

---

### 10. E2Eテストと最終検証

- [ ] 10.1 探索的フィルタリングシナリオテスト
  - 右腕武器スロットで「攻撃力 >= 1000」フィルターを適用し、結果を検証
  - 頭部スロットで「カテゴリ」フィルターを適用し、結果を検証
  - スロット変更時のフィルタークリアを検証
  - フィルター適用後の該当件数表示を検証
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 2.6_

- [ ] 10.2 多様な観点でのソートシナリオテスト
  - 右腕武器スロットで「攻撃力」降順ソートを適用し、結果を検証
  - 頭部スロットで「製造企業」昇順ソートを適用し、文字列ソートを検証
  - スロット変更時の無効なソート属性クリアを検証
  - _Requirements: 3.1, 3.2, 3.3, 3.5, 3.6_

- [ ] 10.3 アクセシビリティ検証
  - 属性選択ドロップダウンのキーボード操作を検証
  - スクリーンリーダーでの属性名・選択状態の読み上げを検証
  - フォーカス管理の適切性を確認
  - _Requirements: 非機能要件（アクセシビリティ）_

- [ ] 10.4 後方互換性検証
  - 既存のフィルター・ソート機能が正常に動作することを確認
  - URL パラメータでのフィルター・ソート状態共有が動作することを確認
  - 既存のテストケースがすべて通過することを確認
  - _Requirements: 非機能要件（互換性）_

---

## 要件カバレッジマトリクス

| 要件ID | 要件概要 | 対応タスク |
|--------|----------|-----------|
| 1.1 | スロット固有属性の提供 | 1.1, 1.2, 2.1, 4.1, 5.1 |
| 1.2 | スロット切り替え時の属性更新 | 4.1, 5.1, 6.1 |
| 1.3 | 属性表示順序の維持 | 1.1, 5.1 |
| 1.4 | 利用可能属性なしのメッセージ | 8.1 |
| 2.1 | フィルターパネルの属性表示 | 5.1, 10.1 |
| 2.2 | 数値属性フィルターUI | 5.2, 7.1, 10.1 |
| 2.3 | 配列属性フィルターUI | 1.3, 2.2, 5.2, 7.1, 10.1 |
| 2.4 | 複数フィルター条件のAND適用 | 2.4, 5.3, 7.1 |
| 2.5 | リアルタイム絞り込み結果表示 | 5.3, 10.1 |
| 2.6 | スロット変更時のフィルタークリア | 4.2, 5.1, 7.1, 10.1 |
| 3.1 | ソートコントロールの属性表示 | 6.1, 10.2 |
| 3.2 | 数値属性ソート | 3.1, 3.4, 6.2, 7.2, 10.2 |
| 3.3 | 配列属性ソート | 3.1, 3.2, 3.4, 6.2, 7.2, 10.2 |
| 3.4 | ソート適用 | 6.2, 7.2 |
| 3.5 | スロット変更時のソート属性切り替え | 4.2, 6.1, 7.2, 10.2 |
| 3.6 | 無効なソート属性の自動クリア | 4.2, 6.2, 7.2, 10.2 |
| 4.1 | 任意属性フィルター時の表示 | 2.4, 7.1 |
| 4.2 | 任意属性フィルター時の除外 | 2.4, 7.1 |
| 4.3 | 必須属性フィルター | - (既存機能) |
| 4.4 | フィルター結果0件のメッセージ | 5.3 |
| 4.5 | 必須属性+任意属性の組み合わせ | 2.4, 7.1 |
| 5.1 | 任意属性ソート時の先頭表示 | 3.3, 3.4, 7.2 |
| 5.2 | 任意属性ソート時の末尾表示 | 3.3, 3.4, 7.2 |
| 5.3 | 属性値でのソート | 3.3, 3.4, 7.2 |
| 5.4 | 属性なしパーツの順序維持 | 3.3, 3.4, 7.2 |
| 5.5 | 必須属性ソート | - (既存機能) |
| 6.1 | i18nリソースからの翻訳取得 | 2.3, 5.4, 6.3 |
| 6.2 | 翻訳なし時のフォールバック | 2.3, 5.4, 6.3 |
| 6.3 | フィルターパネルの翻訳表示 | 5.4 |
| 6.4 | ソートコントロールの翻訳表示 | 6.3 |
| 6.5 | フィルター条件文字列化時の翻訳 | 2.3, 5.4 |
| 7.1 | スロット変更100ms以内 | 4.3, 9.1 |
| 7.2 | UI応答性の維持 | 8.2, 9.3 |
| 7.3 | スムーズな結果更新 | 9.2 |
| 7.4 | 大量パーツでの滑らかな動作 | 9.2, 9.3 |
| 7.5 | 翻訳の即座適用 | - (Svelte自動最適化) |

---

## 実装順序の推奨

1. **Phase 1（Week 1）**: 基盤整備とフィルタリング機能拡張（タスク 1-2）
   - 属性取得基盤を構築し、動的フィルタリングの土台を作る

2. **Phase 2（Week 2）**: ソート機能拡張とUI統合開始（タスク 3-4）
   - ソート機能を拡張し、PartsListViewに統合

3. **Phase 3（Week 2-3）**: UIコンポーネント完全統合（タスク 5-6）
   - FilterPanelとSortControlを完全に統合

4. **Phase 4（Week 3-4）**: 統合テストとエラーハンドリング（タスク 7-8）
   - 機能全体の統合テストとエラー対応

5. **Phase 5（Week 4）**: パフォーマンス最適化と最終検証（タスク 9-10）
   - パフォーマンス要件を満たし、E2Eテストで最終検証

---

## 成功基準

- ✅ 全要件の受入基準を満たしている
- ✅ 単体テスト・統合テスト・E2Eテストがすべて成功
- ✅ パフォーマンス目標を達成（スロット変更100ms以内、フィルター・ソート50ms以内）
- ✅ 既存機能の後方互換性を維持
- ✅ アクセシビリティ要件を満たしている
- ✅ コードレビューで設計指針への準拠を確認
