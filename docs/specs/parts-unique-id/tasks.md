# 実装計画

- [ ] 1. パーツ型定義の拡張とID付与の基盤構築
- [x] 1.1 パーツ型にグローバルユニークIDフィールドを追加
  - `ACParts`型に`id: string`フィールドを追加
  - 全パーツ型（Head, Core, Arms, Legs, Unit等）でIDフィールドが利用可能であることを確認
  - 型定義の互換性を保ちながら段階的に拡張
  - _Requirements: 1.1, 1.2_

- [x] 1.2 ID生成スクリプトの実装
  - カテゴリコードマッピング（head→HD, core→CR, arms→AR等）を定義
  - 既存パーツ配列を読み込み、カテゴリごとに次の連番を計算する機能を実装
  - `{2-3文字カテゴリコード}{3-4桁連番}`形式でID生成
  - コマンドライン引数でカテゴリを指定し、次のユニークIDを出力
  - _Requirements: 1.2, 5.2_

- [x] 1.3 全パーツ定義ファイルにIDを付与
  - ID生成スクリプトを使用し、各カテゴリの全パーツにIDを付与
  - 同一パーツが複数部位で参照される場合、1つのIDのみ付与されることを確認
  - heads.ts, arms.ts, cores.ts, legs.ts, arm-units.ts, back-units.ts等の全パーツ定義ファイルを更新
  - _Requirements: 1.1, 1.3, 1.6_

- [ ] 2. ID重複検証機能の実装
- [x] 2.1 ID重複検証ロジックの実装
  - 全パーツ配列を受け取り、IDの重複を検証する純粋関数を実装
  - 重複検出時は重複ID、競合パーツ名をエラー情報として返却
  - 構造化ログ（JSON形式）でエラーを出力
  - _Requirements: 1.4, 1.5_

- [x] 2.2 起動時ID検証の組み込み
  - アプリケーション起動時に全パーツのID検証を実行
  - ID重複検出時はエラーログ出力（error レベル）し、起動を中断
  - 検証成功時はinfo レベルでログ出力
  - _Requirements: 1.4, 1.5_

- [x] 2.3 ビルドプロセスへのID検証統合
  - ビルドスクリプトにID重複検証を追加
  - 重複検出時はビルドを失敗させ、重複IDと競合パーツを明示したエラーメッセージを出力
  - 検証成功時はビルドを継続
  - _Requirements: 5.3, 5.4_

- [ ] 3. IDベース引当機能の実装
- [x] 3.1 パーツID検索機能の実装
  - 候補配列からパーツIDで検索し、該当するパーツオブジェクトを返却する関数を実装
  - パーツIDが存在しない場合はフォールバック処理（デフォルトパーツまたはNotEquipped）を実行
  - 全部位（head, core, arms, legs, 武器・肩武器、booster, fcs, generator, expansion）で動作することを確認
  - _Requirements: 2.1, 2.2_

- [x] 3.2 v2形式URLシリアライザーの実装
  - 機体構成からv2形式URLクエリパラメータを生成する機能を実装
  - `v=2`パラメータを必ず含める
  - 各部位のパーツIDをクエリパラメータに変換（例: `h=HD001&c=CR002`）
  - URL長がブラウザ制限（2084バイト）内に収まることを確認
  - _Requirements: 2.3, 2.7_

- [x] 3.3 v2形式URLデシリアライザーの実装
  - v2形式URLクエリパラメータから機体構成を復元する機能を実装
  - `v=2`パラメータを検出し、IDベース引当を実行
  - 存在しないパーツIDの場合はフォールバック処理を実行
  - 全部位の機体構成を正しく復元できることを確認
  - _Requirements: 2.4_

- [x] 4. v1形式互換性と自動変換機能の実装
- [x] 4.1 v1形式検出ロジックの実装
  - URLクエリパラメータに`v`パラメータが存在しない場合、v1形式と判定
  - IndexedDBデータのクエリ文字列から`v`パラメータの有無を検証
  - v1/v2を明確に判定し、適切な処理に分岐
  - _Requirements: 3.1, 3.4_

- [x] 4.2 v1→v2変換ロジックの実装
  - v1形式のインデックスから候補配列のパーツオブジェクトを取得
  - 取得したパーツオブジェクトのグローバルIDを使用してv2形式へ変換
  - 同一パーツが複数部位で異なるインデックスを持つケースに対応
  - インデックスが範囲外の場合はフォールバック処理を実行し、warnレベルでログ出力
  - _Requirements: 3.2, 3.3, 3.6_

- [x] 4.3 URL自動変換機能の統合
  - URLデシリアライザーにv1形式検出・変換ロジックを統合
  - v1形式URLを受け取った場合、自動的にv2形式Assemblyへ変換
  - 変換成功時はinfoレベルでログ出力
  - 変換失敗時は分かりやすいエラーメッセージを表示
  - _Requirements: 3.2, 3.6_

- [x] 5. IndexedDBストレージのv2形式対応と移行機能の実装
- [x] 5.1 StoredAssemblyDtoスキーマのv2形式対応
  - Zodスキーマの正規表現をv1/v2両形式に対応
  - `assembly`フィールドがv1形式（`h=0&c=1`）とv2形式（`v=2&h=HD001`）の両方を許容
  - スキーマ検証が正しく動作することを確認
  - _Requirements: 2.5_

- [x] 5.2 IndexedDB保存処理のv2形式対応
  - 機体構成保存時にv2形式URLシリアライザーを使用
  - `assembly`フィールドにv2形式クエリ文字列を保存
  - 既存のストレージリポジトリインターフェースを維持
  - _Requirements: 2.5_

- [x] 5.3 IndexedDB読み込み時のv1形式自動変換
  - データ読み込み時に`v`パラメータの有無でv1/v2を判定
  - v1形式データを検出した場合、v1→v2変換を実行
  - 変換後のデータは読み込み時にAssemblyとして復元される（自動変換）
  - 次回保存時にv2形式で保存される
  - _Requirements: 3.4, 3.5_

- [x] 5.4 IndexedDB全データ移行処理の実装
  - IndexedDBバージョン2へのアップグレード時に自動的にv1形式データをv2形式へ変換
  - setupDataBase関数でCandidatesを受け取り、upgradeコールバック内で参照
  - 変換成功時はinfo、失敗時はerrorレベルでログ出力
  - _Requirements: 3.5, 3.6_

- [x] 6. パッチバージョン対応とID管理ガイドラインの整備
- [x] 6.1 ID不変性の確保とパッチ適用フローの確立
  - 新規パーツ追加時に新しいユニークIDを付与する手順を文書化
  - パーツ削除時にIDを保持し、フォールバック処理が機能することを確認
  - パーツステータス変更時にIDを変更せず、ステータスのみ更新する手順を確立
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 6.2 ID管理ドキュメントの作成
  - ID命名規則（カテゴリコード、連番形式）を文書化
  - ID生成方法（スクリプト使用手順）を記載
  - ID重複チェック手順（起動時検証、ビルド時検証）を説明
  - パッチバージョン適用時のID管理方針を明記
  - _Requirements: 5.1_

- [ ] 7. 統合テストとエンドツーエンド検証
- [x] 7.1 URL共有フローの統合テスト
  - v2形式URL生成→共有→読み込みのフローを検証
  - v1形式URL読み込み→自動変換→機体構成復元を検証
  - 全部位のパーツが正しく引当されることを確認
  - URL長が制限内に収まることを確認
  - _Requirements: 2.3, 2.4, 3.2_

- [x] 7.2 IndexedDBストレージフローの統合テスト
  - v2形式での保存→読み込みフローを検証
  - v1形式データ読み込み→自動変換→v2形式保存を検証
  - 次回読み込み時にv2形式として処理されることを確認
  - _Requirements: 2.5, 2.6, 3.5_

- [x] 7.3 ID重複検証の統合テスト
  - 起動時ID検証が正しく動作することを確認（重複なし、重複あり両方）
  - ビルド時ID検証が正しく動作することを確認（ビルド成功、ビルド失敗両方）
  - エラーログが適切な形式で出力されることを確認
  - _Requirements: 1.4, 1.5, 5.3, 5.4_

- [x] 7.4 パフォーマンス検証
  - 全パーツID検証が起動時100ms以内で完了することを確認
  - v1→v2変換が500ms以内で完了することを確認
  - URL長が12部位全装備時に2084バイト以内であることを確認
  - _Requirements: 2.7_

- [ ] 8. エラーハンドリングとログ出力の実装
- [x] 8.1 構造化ログの実装
  - JSON形式の構造化ログを実装（info, warn, error レベル）
  - 機微情報を含めないログ出力を確保
  - ID重複検出、v1形式検出、変換成功・失敗のログを実装
  - _Requirements: 1.5_

- [x] 8.2 ユーザー向けエラーメッセージの実装
  - パーツID不存在時のフォールバック処理とメッセージ表示
  - v1形式変換失敗時のエラーメッセージとデータ再作成案内
  - IndexedDB接続失敗時のエラーページと再試行ボタン
  - _Requirements: 2.2, 3.6_

- [ ] 9. 単体テストの実装
- [ ] 9.1 ID生成・検証ロジックの単体テスト
  - ID生成スクリプトのテスト（カテゴリごとの連番生成、重複回避）
  - ID重複検証ロジックのテスト（重複なし、重複ありの両ケース）
  - _Requirements: 1.2, 1.4, 1.5_

- [ ] 9.2 v1→v2変換ロジックの単体テスト
  - インデックスからパーツオブジェクト取得のテスト
  - グローバルID取得のテスト
  - フォールバック処理のテスト（インデックス範囲外）
  - _Requirements: 3.2, 3.3_

- [ ] 9.3 シリアライザー・デシリアライザーの単体テスト
  - v2形式URL生成のテスト（`v=2`パラメータ含有、全部位のID変換）
  - v2形式URL読み込みのテスト（全部位の機体構成復元）
  - v1形式URL自動変換のテスト（v1検出、変換、Assembly復元）
  - _Requirements: 2.3, 2.4, 3.2_

- [ ] 9.4 IndexedDBストレージの単体テスト
  - v2形式保存・読み込みのテスト
  - v1形式データ自動変換のテスト
  - Zodスキーマ検証のテスト（v1/v2両形式の受け入れ）
  - _Requirements: 2.5, 2.6, 3.4, 3.5_
