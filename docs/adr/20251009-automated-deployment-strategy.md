# 依存更新の自動デプロイと機能追加の手動リリースフロー

- ステータス: 承認済み
- 日付: 2025-10-09
- タグ: deployment, ci/cd, cloudflare-pages, security

## 背景 / 文脈

個人開発プロジェクトにおいて、セキュリティパッチなど依存関係の更新を迅速に本番環境へ反映させたい一方で、機能追加やバグ修正は明示的なバージョン管理と手動リリースプロセスを経由させたい。どのようなデプロイ戦略を採用すべきか？

## 決定ドライバ

- セキュリティパッチの迅速な本番反映（週10回程度の依存更新を想定）
- 機能追加・変更は明示的なバージョン管理を必須とする
- 個人開発のため、複雑な承認フローは不要
- Cloudflare Pagesへのデプロイを前提
- renovate/dependabotによる依存更新は手動レビュー済み
- アプリケーションにはコミットハッシュを表示しており、デプロイ内容の追跡が可能

## 検討した選択肢

1. すべてのマージで自動デプロイ
2. タグベースの手動デプロイのみ
3. 依存更新は自動デプロイ、機能追加は手動デプロイ（採用）

## 決定（採択）

選択したオプション: "依存更新は自動デプロイ、機能追加は手動デプロイ"。理由: セキュリティ要件（迅速な依存更新反映）と品質管理（機能追加の明示的バージョン管理）の両立が可能。

### 実装方針

**依存更新フロー**:
```
renovate/dependabot PR → 手動レビュー → マージ →
自動的にCloudflare Pagesへデプロイ
（バージョンアップなし、タグなし、Releaseなし）
```

**機能追加/修正フロー**:
```
changeset追加 → PR → マージ →
changesetがversion PR作成 → レビュー → マージ →
手動でworkflow_dispatch実行 →
タグ作成 → Release作成 → Cloudflare Pagesへデプロイ
```

### 技術実装

- Wrangler CLI経由でCloudflare Pagesへデプロイ（Git統合の自動デプロイは使用しない）
- PRマージ時のブランチ名で依存更新を判定（`renovate/`, `dependabot/`）
- 依存更新はバージョン管理対象外（コミットハッシュで追跡）
- 機能追加・変更・バグ修正はchangesetによるバージョン管理

## 影響評価

- **セキュリティ**: 依存更新の迅速な本番反映により、セキュリティパッチの適用遅延リスクを軽減
- **パフォーマンス**: Cloudflare PagesのCDN配信により影響なし
- **ユーザー体験**: 依存更新による破壊的変更は手動レビューで検出済み、機能追加は明示的なリリースプロセスを経由
- **アクセシビリティ**: 影響なし
- **トレーサビリティ**: コミットハッシュ表示により、どのバージョンがデプロイされているか追跡可能。Cloudflare側のデプロイ通知でSlack連携

### ポジティブな影響

- セキュリティパッチの迅速な適用
- 依存更新の手動リリース作業が不要
- 機能追加は明示的なバージョン管理で品質担保
- PRプレビュー環境による事前確認が可能

### ネガティブな影響 / トレードオフ

- 依存更新でバージョン番号が変わらないため、リリースノートに含まれない
- 依存更新による問題発生時は手動ロールバックが必要

## 各選択肢の利点と欠点

### すべてのマージで自動デプロイ

- 良い点: シンプルなワークフロー
- 良い点: 手動操作が不要
- 悪い点: 機能追加の明示的なバージョン管理ができない
- 悪い点: リリースタイミングの制御ができない

### タグベースの手動デプロイのみ

- 良い点: すべてのデプロイが明示的
- 良い点: バージョン管理が厳格
- 悪い点: 依存更新のたびに手動リリース作業が発生（週10回）
- 悪い点: セキュリティパッチの適用が遅延するリスク

### 依存更新は自動デプロイ、機能追加は手動デプロイ（採用）

個人開発における現実的なバランスを実現。

- 良い点: セキュリティパッチの迅速な適用
- 良い点: 機能追加は明示的なバージョン管理
- 良い点: 週10回の依存更新に対する手動作業が不要
- 悪い点: 2つの異なるデプロイフローの管理が必要
- 悪い点: 依存更新がリリースノートに含まれない（コミットハッシュで追跡）

## フォローアップ / 移行計画

1. GitHub Actionsの環境 `web` に `CLOUDFLARE_API_TOKEN` と `CLOUDFLARE_ACCOUNT_ID` を設定
2. 依存更新PRで動作確認
3. 機能追加リリースで動作確認
4. 問題発生時のロールバック手順を文書化

## 参考リンク

- [Cloudflare Pages - Direct Upload](https://developers.cloudflare.com/pages/platform/direct-upload/)
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/)
- [GitHub Actions - cloudflare/wrangler-action](https://github.com/cloudflare/wrangler-action)
- [Changesets](https://github.com/changesets/changesets)