# SSR移行検討の分析と判断

- Status: Proposed
- Date: 2025-09-10
- Related: SSG -> SSR migration consideration

## 背景 / 文脈

現在のアプリケーションは、Cloudflare Pages 上で SvelteKit を使用して静的サイト生成（SSG）モードで稼働している。Cloudflare Workers への移行により、SSR（Server Side Rendering）への移行が技術的に可能となった。

今後予想される要件：
- 別ページの追加
- フィルタリング機能やパーツ情報API等の動的機能の提供
- 可能な限り無料枠での運用継続

## 目標

- 現行アプリケーションの最適な配信戦略の決定
- 将来の機能拡張への対応
- Cloudflare無料枠での継続的な運用可能性の確保
- パフォーマンス・SEO・開発生産性のバランス最適化

## 現状分析

### 現行構成
- **フレームワーク**: SvelteKit with `@sveltejs/adapter-static`
- **配信**: Cloudflare Pages（SSG）
- **ビルド**: 静的生成、`dist/`フォルダへの出力
- **特徴**: 全ページがビルド時に事前生成される

### パフォーマンス分析

#### SSG（現行）のメリット
- **初期表示速度**: 事前生成されたHTMLによる高速な初期描画
- **キャッシング効率**: CDNでの長期キャッシュが可能
- **サーバー負荷**: 実質的にサーバー処理不要（配信のみ）
- **SEO**: 事前生成HTMLにより検索エンジンクローリングが確実

#### SSR移行時のメリット
- **動的コンテンツ**: リクエスト時のデータ生成・個人化が可能
- **機能拡張性**: フィルタリングやAPI機能の実装が容易
- **データの鮮度**: 常に最新の情報を提供可能

#### SSR移行時のデメリット・リスク
- **レスポンス時間**: リクエスト毎のサーバー処理による遅延
- **CPU制約**: Cloudflare Workers無料枠の10ms CPU制限
- **コスト増加**: 動的処理によるリクエスト毎の処理コスト
- **複雑性増加**: サーバーサイド処理の管理・デバッグの複雑化

## Cloudflare Workers無料枠制限の影響

### 制限事項（2025年現在）
- **CPU時間**: 10ms/リクエスト（無料枠）
- **リクエスト数**: 100,000リクエスト/日、1,000リクエスト/分
- **メモリ**: 128MB/Worker

### SSRにおけるCPU時間消費分析
- **軽量なSvelteKit処理**: 通常1-2ms程度
- **JSON処理・DB操作**: 大量データ処理時に3.3MB JSONで制限超過の実例あり
- **ロールオーバーバンク**: 未使用CPU時間の蓄積による一時的な制限緩和

### 実運用での制約
現実的にはシンプルなSvelteKit SSRであっても、データベースクエリや複雑な計算によって10ms制限を超過する可能性がある。特に「フィルタリングやパーツ情報API」等の機能は、この制限に引っかかるリスクが高い。

## 代替案の検討

### 案1: 現状維持（SSG継続）
**採択理由**:
- 現在の要件（静的コンテンツ中心）に最適
- Cloudflare無料枠の制約を受けない
- 高いパフォーマンスとSEO効果を維持
- 運用コストゼロ

**制限事項**:
- 動的機能実装の制約
- リアルタイムデータ更新不可

### 案2: 完全SSR移行
**却下理由**:
- Cloudflare Workers無料枠のCPU制限により、想定される機能（フィルタリング等）で制限超過のリスク
- 現行の静的コンテンツに対してオーバーエンジニアリング
- パフォーマンス劣化の可能性

### 案3: ハイブリッド構成（推奨案）
- **静的ページ**: SSGで継続（メインコンテンツ）
- **動的機能**: 別途API Routes または Cloudflare Functions で実装
- **段階的移行**: 必要に応じて特定ページのみSSR化

## 推奨決定

### 短期的判断: **SSG継続**
現在の要件と制約を総合的に判断し、以下の理由でSSG継続を推奨：

1. **現行要件適合性**: 主にタスク管理ツールとしての静的機能が中心
2. **パフォーマンス最適性**: 事前生成による高速表示
3. **運用コスト**: Cloudflare無料枠での確実な運用継続
4. **リスク最小化**: 既存の安定稼働システムの保持

### 中長期的戦略: **段階的ハイブリッド化**
将来の機能拡張に備えた段階的なアプローチ：

1. **API機能**: Cloudflare Functions / Workers を活用した API エンドポイント
2. **動的ページ**: 必要に応じて特定ページのみSSR化（SvelteKitのpage-level rendering選択）
3. **モニタリング**: CPU使用量とパフォーマンス指標の継続的監視

## 実装上の考慮事項

### 将来のSSR移行に備えた準備
- SvelteKitの設定でpage-level renderingの柔軟な選択を可能にする
- API Routes の段階的な導入検討
- パフォーマンス監視ツールの導入

### 監視指標
- **Lighthouse Score**: パフォーマンス指標の継続的な監視
- **CPU使用量**: 将来のSSR化時の制限超過リスク評価
- **ユーザー体験**: 動的機能の必要性評価

## 結論

**現時点では SSG（現行構成）の継続を推奨**

理由：
- 現在の要件に最適化されている
- Cloudflare無料枠での確実な運用が可能
- 高いパフォーマンスとSEO効果を維持
- 将来の段階的な機能拡張に対応可能

**将来の判断指標**：
- 動的機能の具体的な要件定義
- ユーザーからのリアルタイム更新ニーズ
- Cloudflare Workers無料枠制限の変更
- アプリケーションの成長とトラフィック増加

この判断により、現行システムの安定性と性能を保持しながら、将来の拡張性も確保できる。