# Development Rules

本ドキュメントは、このリポジトリにおける **ソフトウェア開発上の判断基準・背景・運用ルール**をまとめたものです。

AGENTS.md は「破ったら NG な強制規則」を定義しますが、本ドキュメントは **なぜその規則が存在するのか／どう判断すべきか**を補足します。

## 1. 基本方針

* このリポジトリは **アーマードコア6（AC6）向けメカカスタマイズ支援アプリ**の monorepo である。
* 設計上、最も重視するのは以下である。
  * 変更理由の明確化
  * ドメイン知識の一貫性
  * 境界（package / 層）をまたぐ影響範囲の最小化
* **曖昧または矛盾する要求に対しては、推測で対応せず確認を求めること**。

「動くかどうか」よりも「どこをどう変えればよいかが分かるか」を優先する。

## 2. パッケージ分割の思想

### 内側と外側

* parts / core は **内側**であり、安定しているべき層
* api / web は **外側**であり、変更頻度が高い層

依存は必ず **外側 → 内側** の一方向とする。

### なぜ web と api を分離するか

* UI 都合と HTTP 都合は、変更理由が異なる
* UI は画面構成や UX で変わる
* API は通信・認証・公開インターフェースで変わる

両者を混ぜると、変更理由が絡まり、影響範囲が読めなくなる。

## 3. 変更理由による構造設計

### 集約の原則

* 同じ要求・仕様変更で **同時に編集されるもの**は、近くに置く
* ファイル／ディレクトリ／クラス単位で集約する

これは「見通しの良さ」と「一括変更のしやすさ」を優先するためである。

### 分離の原則

* 変更理由が異なり、片方だけが編集されることが多いものは分離する
* 無理に DRY にせず、変更単位を優先する

これは「将来の変更コスト」を下げるためである。

## 4. 設計原則の優先度

以下の優先度で設計判断を行う。

**可逆性 > 低結合 = 高凝集 = 直交性 > KISS = YAGNI > DRY**

* **可逆性**: 判断を後から覆せるか。覆せない決定は慎重に行う
* **低結合 / 高凝集 / 直交性**: モジュール境界の健全性。同列で考慮する
* **KISS / YAGNI**: 今必要なものだけを、単純に作る
* **DRY**: 重複排除は最後。変更理由が異なるなら重複を許容する

## 5. 型安全性と parse, don't validate

### 問題意識

* 無効な状態を保持するオブジェクトは、後段のロジックを複雑にする
* バリデーション後に string / number のまま値を持つと、
  * どこで安全になったのか
  * どこで再検証が必要か
    が分からなくなる

### 方針

* TypeScript の型システムを最大限活用する
* 入力は必ず「意味のある型」へパースする
* パースに成功した時点で、その値は **常に正しい**とみなせる
* 不正な入力はオブジェクトを生成しない
* `any` / `as` によるキャストは原則禁止

これにより、core 内では防御的コードを最小化できる。

## 6. Result 型によるエラー表現

### なぜ例外を使わないか

* core は UI / HTTP に依存しない
* 例外は制御フローを見えにくくする
* エラーが暗黙に伝播すると、層をまたいだ責務が混ざる

### 方針

* core は Result 型で成功／失敗を明示する
* api / web は Result を、それぞれの責務（HTTP / UI）に変換する
* ユーザーが自力で解決／回避できない種類のエラーのみ、例外を使う

これにより、

* エラーの発生源
* エラーの扱い場所

を明確にする。

## 7. 構造化ログ

### 方針

* JSON 形式で出力する
* ログレベルは info / debug / warn / error / fatal を遵守する（docs/terms.md 参照）
* 以下の情報は **絶対にログに含めない**
  * 認証情報（トークン、パスワード、API キー）
  * 個人情報（氏名、メールアドレス、住所など）
  * 金融データ
  * Secrets

## 8. テスト配置と責務

### テストを「隣」に置く理由

* 実装とテストの乖離を防ぐ
* 変更時にテストの存在を見落とさない

### e2e を分離する理由

* e2e は変更理由・実行コストが他のテストと異なる
* すべてを隣に置くと、テストの性質が混ざる

そのため、e2e のみ `packages/e2e` に集約する。

## 9. 用語管理（docs/terms.md）

### なぜ用語を固定するか

* AC6 のドメインは用語が多く、曖昧さがバグを生む
* 同じ概念に異なる名前を与えると、設計の一貫性が崩れる

### 方針

* docs/term.md を単一の正典とする
* 実装・ドキュメント・議論は、この用語に従う

## 10. 仕様変更とドキュメント更新

### 仕様変更とは何か

以下に該当する場合、仕様変更とみなす。

* 公開 API / UI / CLI / core 関数の入出力変更
* エラー条件・境界条件の変更
* 推奨される使い方の変更

### なぜ厳密に定義するか

* 「実装は正しいが docs が嘘」という状態を防ぐため
* 将来の利用者（人間・AI）に誤解を残さないため

## 11. 機械的検証を前提とする理由

* 人間も AI も規則を忘れる
* 忘れた結果、境界違反は静かに侵食する

そのため、

* 依存方向
* import ルール
* workspace 構成

は CI で必ず検証する。

## 12. 禁止事項

以下の操作は **明示的な許可なく行ってはならない**。

* 本番環境の操作
* Secrets / 認証情報の出力・露出
* 依存パッケージの無断追加
* main ブランチへの直接 push

## 13. 最後に

これらのルールは、開発速度を落とすためのものではない。

* 「どこを触ればよいか分かる」
* 「壊したときに、どこが壊れたか分かる」

この状態を長期にわたって維持するためのものである。
